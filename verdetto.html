<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantalagh√®e 25/26 - Il Fanta dei Lagh√®e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .widget { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .cucchiaio-legno { border-color: #854d0e; background-color: #854d0e20; }
        .cucchiaio-legno h2 { color: #facc15; }
        .cucchiaio-legno p { color: #fefce8; }

        .premio-punteggio { border-color: #facc15; background-color: #facc1520; }
        .premio-punteggio h2 { color: #facc15; }
        .premio-punteggio p { color: #fefce8; }

        /* Stili per DataTables */
        #classifica-table_wrapper { background-color: var(--card-bg); padding: 1rem; border-radius: 0.5rem; }
        #classifica-table { color: var(--primary-text); }
        #classifica-table th, #classifica-table td { border-bottom: 1px solid var(--border-color); }
        .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate { color: #9ca3af; }
        .dataTables_paginate .paginate_button { color: #9ca3af !important; }
        .dataTables_paginate .paginate_button.disabled { color: #4b5563 !important; }
    </style>
</head>
<body class="antialiased">
    <div class="background-container"></div>
    <div class="background-overlay"></div>

    <header id="main-header" class="sticky top-0 z-50 backdrop-blur-lg border-b border-gray-700">
        <div class="container mx-auto px-4 flex justify-between items-center h-16">
            <a href="/index.html"><img src="/image/logo-header.jpg" alt="Fanta Lagh√®e Logo" class="h-12"></a>
            <nav class="hidden md:flex items-center gap-1">
                <a href="/index.html#panoramica" class="nav-button nav-link px-4 py-2 rounded-full text-sm">Panoramica</a>
                <a href="/index.html#novita" class="nav-button nav-link px-4 py-2 rounded-full text-sm">Novit√†</a>
                <a href="/index.html#regole" class="nav-button nav-link px-4 py-2 rounded-full text-sm">Regolamento</a>
                <a href="/index.html#mercato" class="nav-button nav-link px-4 py-2 rounded-full text-sm">Mercato</a>
                <a href="/index.html#bonus-malus" class="nav-button nav-link px-4 py-2 rounded-full text-sm">Bonus/Malus</a>
                <a href="/index.html#partecipanti" class="nav-button nav-link px-4 py-2 rounded-full text-sm">I Protagonisti</a>
                <a href="/gazzetta-del-laghee.html" class="nav-button nav-link nav-gazzetta px-4 py-2 rounded-full text-sm">Gazzetta</a>
                <a href="/verdetto.html" class="nav-button nav-link nav-verdetto px-4 py-2 rounded-full text-sm">Il Verdetto</a>
            </nav>
            <div class="flex items-center gap-2">
                <a href="/docs/regolamento-fantalaghee-2526.pdf" download class="btn-secondary px-4 py-2 rounded-full text-sm uppercase hidden sm:block">PDF</a>
                <a href="https://forms.gle/HRBX3hvc351Y2Mai7" target="_blank" class="btn-iscriviti px-4 py-2 rounded-full text-sm uppercase hidden sm:block">Iscriviti</a>
                <button id="hamburger-btn" class="md:hidden p-2"><svg id="hamburger-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg><svg id="hamburger-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
        </div>
    </header>
    <div id="mobile-menu" class="hidden"></div>

    <main class="container mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center py-8">
            <h1 class="text-4xl lg:text-5xl font-bold text-white mb-2" style="font-family: 'Oswald', sans-serif;">IL VERDETTO DEL LAGH√àE</h1>
            <p id="giornata-info" class="text-lg text-amber-400 font-semibold">Dati in caricamento...</p>
        </header>
        <div id="loader-container" class="flex justify-center items-center py-24"><div class="loader"></div></div>
        <div id="dashboard-content-wrapper" class="hidden">
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- I widget verranno inseriti qui da JS -->
            </div>
            <section id="classifica-section">
                <h3 class="text-2xl font-bold text-indigo-400 mb-4 text-center" style="font-family: 'Oswald', sans-serif;">CLASSIFICA GENERALE</h3>
                <div id="standings-container" class="overflow-x-auto rounded-lg border border-gray-700 p-4 bg-gray-900/50">
                     <div class="text-center py-16">
                        <div class="loader mx-auto"></div>
                        <h3 class="text-xl sm:text-2xl font-semibold text-stone-300 mt-4">Caricamento classifica...</h3>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- jQuery (Dependency for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="/js/main.js" defer></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('loader-container');
        const wrapper = document.getElementById('dashboard-content-wrapper');
        const info = document.getElementById('giornata-info');
        const dashboardContainer = wrapper.querySelector('.grid');
        const standingsContainer = document.getElementById('standings-container');

        const createCard = (title, value, subtitle = '', icon = '', customClass = '') => {
            if (!value) return '';
            return `<div class="widget text-center ${customClass}"><h2 class="text-sm font-bold uppercase">${icon} ${title}</h2><p class="text-4xl font-bold">${value}</p><p class="text-md text-stone-400">${subtitle}</p></div>`;
        };

        try {
            const response = await fetch('/api/getClassificaV2');
            if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
            const data = await response.json();
            if(data.error) throw new Error(data.details);

            const { dashboard, classifica } = data;

            // --- Render Dashboard (pi√π robusto) ---
            if (dashboard && Object.keys(dashboard).length > 0) {
                if (dashboard.campioneDellaGiornata && dashboard.campioneDellaGiornata.giornata) {
                    info.textContent = `Dati aggiornati alla ${dashboard.campioneDellaGiornata.giornata}`;
                } else {
                    info.textContent = 'Verdetto della settimana';
                }

                let dashboardHTML = '';
                if (dashboard.leaderAttuale) dashboardHTML += createCard('Leader Attuale', dashboard.leaderAttuale.team, ``, 'üèÜ');
                if (dashboard.recordAssoluto) dashboardHTML += createCard('Record Assoluto', dashboard.recordAssoluto.team, `Punteggio: ${dashboard.recordAssoluto.punteggio}`, 'üî•', 'premio-punteggio');
                if (dashboard.campioneDellaGiornata) dashboardHTML += createCard('Campione della Giornata', dashboard.campioneDellaGiornata.team, `Punteggio: ${dashboard.campioneDellaGiornata.punteggio}`, 'ü•á');
                if (dashboard.cucchiaioDiLegno) dashboardHTML += createCard('Cucchiaio di Legno', dashboard.cucchiaioDiLegno.team, `Punteggio: ${dashboard.cucchiaioDiLegno.punteggio}`, 'ü•Ñ', 'cucchiaio-legno');
                if (dashboard.migliorPunteggio) dashboardHTML += createCard('Miglior Punteggio', dashboard.migliorPunteggio.team, `Punti: ${dashboard.migliorPunteggio.punteggio}`, 'üéØ', 'premio-punteggio');
                dashboardContainer.innerHTML = dashboardHTML;

                // --- NUOVO: Render Premi di Giornata ---
                if (dashboard.premiDiGiornata && dashboard.premiDiGiornata.length > 0) {
                    let premiHTML = `<div class="col-span-full mt-8"><h3 class="text-2xl font-bold text-amber-400 mb-4 text-center" style="font-family: 'Oswald', sans-serif;">PREMI DI GIORNATA</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">`;
                    dashboard.premiDiGiornata.forEach(premio => {
                        premiHTML += createCard(premio.squadra, `${premio.premio} üçÜ`, 'Premio Giornata', '‚≠ê');
                    });
                    premiHTML += `</div></div>`;
                    dashboardContainer.insertAdjacentHTML('afterend', premiHTML);
                }

            } else {
                info.textContent = 'Dati non disponibili';
                dashboardContainer.innerHTML = '<p class="text-center col-span-full text-amber-400">Nessun dato disponibile per la dashboard.</p>';
            }

            // --- Render Standings Table (invariato) ---
            if (classifica && classifica.length > 0) {
                const headers = Object.keys(classifica[0]);
                const tableHTML = `
                    <table id="classifica-table" class="display compact stripe" style="width:100%">
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    </table>`;
                standingsContainer.innerHTML = tableHTML;

                new DataTable('#classifica-table', {
                    data: classifica,
                    columns: headers.map(h => ({ data: h, title: h })),
                    responsive: true,
                    language: { url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/it-IT.json' },
                    order: [[0, 'asc']],
                    createdRow: function(row, data, dataIndex) {
                        const pos = parseInt(data.POS);
                        if (pos <= 3) $(row).css('background-color', 'rgba(34, 197, 94, 0.1)');
                        if (pos >= 8) $(row).css('background-color', 'rgba(239, 68, 68, 0.1)');
                    },
                    columnDefs: [{
                        targets: '_all',
                        render: function(data, type, row, meta) {
                            if (type === 'display' && meta.col > 0) {
                                return `<div class="tooltip-container">${data}<span class="tooltip-text">Clicca per dettagli</span></div>`;
                            }
                            return data;
                        }
                    }]
                });
            } else {
                standingsContainer.innerHTML = '<p class="text-center text-amber-400">Nessun dato disponibile per la classifica.</p>';
            }

            loader.style.display = 'none';
            wrapper.classList.remove('hidden');

        } catch (error) {
            console.error("Errore caricamento Verdetto:", error);
            info.textContent = 'Dati non disponibili. Riprova pi√π tardi.';
            loader.style.display = 'none';
            wrapper.innerHTML = `<p class="text-center col-span-full text-red-400">Impossibile caricare la pagina. Dettaglio: ${error.message}</p>`;
        }
    });
</script>
</body>
</html>
