<script>
document.addEventListener('DOMContentLoaded', async () => {
    const loader = document.getElementById('loader-container');
    const wrapper = document.getElementById('dashboard-content-wrapper');
    const info = document.getElementById('giornata-info');

    try {
        // CHIAMIAMO LA NUOVA API INTELLIGENTE
        const response = await fetch('/api/getVerdettoV2');
        if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
        
        const data = await response.json();
        if (data.error) throw new Error(data.details);

        const { dashboard, classifica } = data;

        // Aggiorniamo il titolo con le info sulla giornata
        info.textContent = dashboard.giornataInfo ? `Dati aggiornati a: ${dashboard.giornataInfo}` : 'Dati non disponibili';

        // Ricostruiamo l'HTML con il layout corretto
        wrapper.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="widget text-center"><h2 class="text-sm font-bold uppercase text-indigo-400">üèÜ Leader Attuale</h2><p class="text-4xl font-bold">${dashboard.leaderAttuale?.team || 'N/D'}</p></div>
                <div class="widget text-center"><h2 class="text-sm font-bold uppercase text-indigo-400">üî• Record Assoluto</h2><p class="text-4xl font-bold">${dashboard.recordAssoluto?.punteggio || 'N/D'}</p><p class="text-md text-stone-400">${dashboard.recordAssoluto?.team || ''} (${dashboard.recordAssoluto?.giornata || ''})</p></div>
                <div class="widget text-center"><h2 class="text-sm font-bold uppercase text-indigo-400">ü•á Campione di Giornata</h2><p class="text-4xl font-bold">${dashboard.campioneDellaGiornata?.team || 'N/D'}</p><p class="text-md text-stone-400">Punti: ${dashboard.campioneDellaGiornata?.punteggio || ''}</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 widget">
                    <h2 class="text-xl font-bold mb-4">CLASSIFICA GENERALE - TOP 5</h2>
                    <div class="chart-container"><canvas id="classificaChart"></canvas></div>
                </div>
                <div class="space-y-6">
                    <div class="widget">
                        <h2 class="text-xl font-bold mb-4">PODIO DELLA GIORNATA</h2>
                        <div id="podio-container" class="space-y-3"></div>
                    </div>
                </div>
            </div>`;

        // Popoliamo il widget del podio
        const podioContainer = document.getElementById('podio-container');
        if (dashboard.podio && dashboard.podio.length > 0) {
            dashboard.podio.forEach(p => {
                podioContainer.innerHTML += `<div class="flex items-center gap-4">${p.pos} <p><strong>${p.team}</strong> - ${p.punteggio}</p></div>`;
            });
        }

        // Prepariamo i dati per il grafico (SOLO TOP 5)
        const top5Classifica = classifica.slice(0, 5);
        
        // Creiamo il grafico con i tooltip interattivi
        new Chart('classificaChart', {
            type: 'bar',
            data: {
                labels: top5Classifica.map(d => d.SQUADRA),
                datasets: [{
                    data: top5Classifica.map(d => d.PUNTI),
                    backgroundColor: 'rgba(79, 70, 229, 0.8)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1c1917',
                        titleFont: { size: 16, weight: 'bold' },
                        bodyFont: { size: 14 },
                        padding: 12,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const teamData = classifica.find(t => t.SQUADRA === context.label);
                                if (!teamData) return '';
                                return [
                                    `Punti Totali: ${teamData.PUNTI}`,
                                    `Media Punti: ${teamData.MEDIA}`,
                                    `Posizione: ${teamData.POS}¬∞`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        loader.style.display = 'none';
        wrapper.classList.remove('hidden');

    } catch (error) {
        console.error("Errore caricamento Verdetto:", error);
        info.textContent = 'Dati non disponibili. Riprova pi√π tardi.';
        wrapper.innerHTML = `<p class="text-center col-span-full text-red-400">Impossibile caricare i dati. Dettaglio: ${error.message}</p>`;
        loader.style.display = 'none';
        wrapper.classList.remove('hidden');
    }
});
</script>
