<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coppe Fantalaghee 2024/25</title>
    <style>
        :root {
            --sl-color: cyan;
            --cu-color: lime;
            --bg-color: #0d1117;
            --primary-text: #c9d1d9;
            --secondary-text: #8b949e;
            --border-color: #30363d;
            --card-bg: #161b22;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        body {
            background-color: var(--bg-color);
            color: var(--primary-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .tab-button {
            background: none;
            border: none;
            color: var(--secondary-text);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: color 0.2s ease, border-bottom 0.2s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        .tab-button:hover {
            color: var(--primary-text);
        }
        .tab-button.active {
            color: var(--sl-color);
            border-bottom: 2px solid var(--sl-color);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {
            display: block;
        }
        h2 {
            font-size: 28px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
        }
        thead th {
            background-color: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }
        tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        tbody tr:last-child {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .tooltip {
            position: absolute;
            background-color: #21262d;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            display: none;
            pointer-events: none;
            font-size: 14px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        /* Styles for Phases */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }
        .card h3 {
            margin-top: 0;
            color: white;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-sl { background-color: rgba(0, 255, 255, 0.1); color: cyan; }
        .status-playoff { background-color: rgba(255, 165, 0, 0.1); color: orange; }
        .status-cu { background-color: rgba(0, 255, 0, 0.1); color: lime; }

        .brackets-container {
            display: flex;
            gap: 40px;
            justify-content: space-around;
        }
        .bracket {
            display: flex;
            flex-direction: column;
            width: 48%;
        }
        .bracket h2 {
           text-align: center;
        }
        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }
        .match {
            display: flex;
            flex-direction: column;
            margin: 20px 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            position: relative;
        }
        .participant {
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
        .participant:first-child {
            border-bottom: 1px solid var(--border-color);
        }
        .seed {
            color: var(--secondary-text);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tooltip" id="tooltip"></div>
        <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'fase1')">FASE 1: QUALIFICAZIONE</button>
        <button class="tab-button" onclick="openTab(event, 'fase2')">FASE 2: GIRONI</button>
        <button class="tab-button" onclick="openTab(event, 'fase3')">FASE 3: CLASSIFICHE GIRONI</button>
        <button class="tab-button" onclick="openTab(event, 'fase4')">FASE 4: CALENDARIO</button>
        <button class="tab-button" onclick="openTab(event, 'fase5')">FASE 5: TABELLONI</button>
    </div>

    <div id="fase1" class="tab-content active">
        <h2>FASE 1: QUALIFICAZIONE (G1-G9)</h2>
        <div id="classifica-g1-g9"></div>
    </div>

    <div id="fase2" class="tab-content">
        <h2>FASE 2: GIRONI (BISCIONE)</h2>
        <div id="gironi-biscione"></div>
    </div>

    <div id="fase3" class="tab-content">
        <h2>FASE 3: CLASSIFICHE GIRONI (G10-G18)</h2>
        <div id="classifiche-gironi" class="card-container"></div>
    </div>

    <div id="fase4" class="tab-content">
        <h2>FASE 4: CALENDARIO FASE FINALE</h2>
        <div id="calendario-fase-finale"></div>
    </div>

    <div id="fase5" class="tab-content">
        <h2>FASE 5: TABELLONI FINALI (SL & CU)</h2>
        <div id="tabelloni-finali" class="brackets-container"></div>
    </div>
    </div>

    <script>
        // Main function to switch between tabs
        function openTab(event, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.className += " active";
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Fetching data...');
            try {
                const classificaResponse = await fetch('/api/getClassifica_2425');
                const classificaData = await classificaResponse.json();
                console.log('Classifica data:', classificaData);
                const squadreResponse = await fetch('/api/getSquadre');
                const squadreData = await squadreResponse.json();
                console.log('Squadre data:', squadreData);
                const teamMap = new Map(squadreData.map(t => [t.Team_FullName, t.NickName]));

            function getTLA(teamName) {
                return teamMap.get(teamName) || teamName.substring(0, 3).toUpperCase();
            }

            // FASE 1: QUALIFICAZIONE
            const classificaContainer = document.getElementById('classifica-g1-g9');
            let classificaTable = '<table><tr><th>Rank</th><th>Team</th><th>Points</th></tr>';
            classificaData.standings.slice(0, 50).forEach(team => {
                const tla = getTLA(team.strTeam);
                classificaTable += `<tr><td>${team.intRank}</td><td class="team-name" data-full-name="${team.strTeam}">${tla}</td><td>${team.intPoints}</td></tr>`;
            });
            classificaTable += '</table>';
            classificaContainer.innerHTML = classificaTable;

            // FASE 2: GIRONI (BISCIONE)
            const gironiContainer = document.getElementById('gironi-biscione');
            const gironi = Array.from({ length: 5 }, () => []);
            const fasce = Array.from({ length: 10 }, (_, i) => classificaData.standings.slice(i * 5, (i + 1) * 5));
            fasce.forEach((fascia, index) => {
                if (index % 2 === 0) {
                    for (let i = 0; i < 5; i++) gironi[i].push(fascia[i]);
                } else {
                    for (let i = 0; i < 5; i++) gironi[i].push(fascia[4 - i]);
                }
            });
            let gironiTable = '<table><thead><tr><th>Girone A</th><th>Girone B</th><th>Girone C</th><th>Girone D</th><th>Girone E</th></tr></thead><tbody>';
            for (let i = 0; i < 10; i++) {
                gironiTable += `<tr>`;
                for (let j = 0; j < 5; j++) {
                    const team = gironi[j][i];
                    if (team) {
                        const tla = getTLA(team.strTeam);
                        gironiTable += `<td class="team-name" data-full-name="${team.strTeam}">${tla}</td>`;
                    } else {
                        gironiTable += `<td>-</td>`;
                    }
                }
                gironiTable += `</tr>`;
            }
            gironiTable += '</table>';
            gironiContainer.innerHTML = gironiTable;

            // FASE 3: CLASSIFICHE GIRONI (SIMULAZIONE)
            const classificheGironiContainer = document.getElementById('classifiche-gironi');
            let classificheHTML = '';
            gironi.forEach((girone, index) => {
                // Assign simulated points and sort each group to create a realistic leaderboard
                girone.forEach(team => {
                    team.simulatedPoints = Math.floor(Math.random() * 30); // Random points for simulation
                });
                girone.sort((a, b) => b.simulatedPoints - a.simulatedPoints);

                classificheHTML += `<div class="card"><h3>Girone ${String.fromCharCode(65 + index)}</h3>`;
                classificheHTML += '<table><thead><tr><th>Pos</th><th>Team</th><th>Points</th><th>Status</th></tr></thead><tbody>';
                girone.forEach((team, i) => {
                    const tla = getTLA(team.strTeam);
                    let statusBadge;
                    if (i < 4) statusBadge = '<span class="status-badge status-sl">Super Lega</span>';
                    else if (i === 4) statusBadge = '<span class="status-badge status-playoff">Spareggio</span>';
                    else statusBadge = '<span class="status-badge status-cu">Coppa UEFA</span>';
                    classificheHTML += `<tr><td>${i + 1}</td><td class="team-name" data-full-name="${team.strTeam}">${tla}</td><td>${team.simulatedPoints}</td><td>${statusBadge}</td></tr>`;
                });
                classificheHTML += '</tbody></table></div>';
            });
            classificheGironiContainer.innerHTML = classificheHTML;

            // Add tooltip functionality
            const tooltip = document.getElementById('tooltip');
            document.querySelectorAll('.team-name').forEach(elem => {
                elem.addEventListener('mousemove', e => {
                    tooltip.style.display = 'block';
                    tooltip.textContent = elem.dataset.fullName;
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                });
                elem.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });

            // FASE 4: CALENDARIO FASE FINALE
            const calendarioContainer = document.getElementById('calendario-fase-finale');
            calendarioContainer.innerHTML = `
                <table>
                    <tr><th>Turno (A/R)</th><th>Giornate di Campionato</th></tr>
                    <tr><td>Turno 1</td><td>Giornate 19-20</td></tr>
                    <tr><td>Pausa</td><td>Giornata 21</td></tr>
                    <tr><td>Turno 2</td><td>Giornate 22-23</td></tr>
                    <tr><td>Pausa</td><td>Giornata 24</td></tr>
                    <tr><td>Turno 3</td><td>Giornate 25-26</td></tr>
                    <tr><td>Pausa</td><td>Giornata 27</td></tr>
                    <tr><td>Turno 4</td><td>Giornate 28-29</td></tr>
                    <tr><td>Pausa</td><td>Giornata 30</td></tr>
                    <tr><td>Turno 5</td><td>Giornate 31-32</td></tr>
                </table>`;

            // FASE 5: TABELLONI FINALI
            const tabelloniContainer = document.getElementById('tabelloni-finali');
            const superLegaTeams = [];
            const coppaUefaTeams = [];

            gironi.forEach(girone => {
                superLegaTeams.push(...girone.slice(0, 4)); // Top 4 from each group
                coppaUefaTeams.push(...girone.slice(5, 10)); // 6th to 10th from each group
            });
            const spareggioTeams = gironi.map(g => g[4]); // Get all 5th placed teams

            // Sort 5th placed teams by their SIMULATED points
            spareggioTeams.sort((a, b) => b.simulatedPoints - a.simulatedPoints);

            superLegaTeams.push(...spareggioTeams.slice(0, 4)); // Add the best 4
            coppaUefaTeams.push(spareggioTeams[4]); // Add the worst 5th

            // Sort all qualified teams by their ORIGINAL rank for seeding
            superLegaTeams.sort((a, b) => a.intRank - b.intRank);
            coppaUefaTeams.sort((a, b) => a.intRank - b.intRank);

            function createBracket(teams, byes, title, color) {
                let html = `<div class="bracket"><h2 style="color: ${color};">${title}</h2><div class="rounds-container">`;
                const rounds = [];
                let currentRoundTeams = [...teams];
                let roundNum = 1;

                // Create Preliminary Round if needed
                if (byes > 0) {
                    const preliminaryMatches = [];
                    const competitors = currentRoundTeams.slice(byes);
                    for (let i = 0; i < competitors.length / 2; i++) {
                        preliminaryMatches.push([competitors[i], competitors[competitors.length - 1 - i]]);
                    }
                    rounds.push({ name: 'Preliminari', matches: preliminaryMatches });

                    // Winners of prelims + BYEs advance
                    let nextRound = currentRoundTeams.slice(0, byes);
                    preliminaryMatches.forEach(() => nextRound.push({ name: 'TBD' }));
                    currentRoundTeams = nextRound;
                }

                // Create main bracket rounds
                while (currentRoundTeams.length > 1) {
                    const matches = [];
                    for (let i = 0; i < currentRoundTeams.length / 2; i++) {
                        matches.push([currentRoundTeams[i], currentRoundTeams[currentRoundTeams.length - 1 - i]]);
                    }
                    rounds.push({ name: `Turno ${roundNum}`, matches });

                    // Prepare for next round
                    currentRoundTeams = Array(currentRoundTeams.length / 2).fill({ name: 'TBD' });
                    roundNum++;
                }

                // Generate HTML from rounds structure
                rounds.forEach(round => {
                    html += `<div class="round"><h3>${round.name}</h3>`;
                    round.matches.forEach(match => {
                        const team1 = match[0];
                        const team2 = match[1];
                        html += `<div class="match">
                                    <div class="participant"><span class="team-name" data-full-name="${team1.strTeam || ''}">${getTLA(team1.strTeam || team1.name)}</span> <span class="seed">${team1.intRank ? `Seed ${team1.intRank}` : ''}</span></div>
                                    <div class="participant"><span class="team-name" data-full-name="${team2.strTeam || ''}">${getTLA(team2.strTeam || team2.name)}</span> <span class="seed">${team2.intRank ? `Seed ${team2.intRank}` : ''}</span></div>
                                 </div>`;
                    });
                    html += '</div>';
                });

                html += '</div></div>';
                return html;
            }

            const superLegaBracket = createBracket(superLegaTeams, 8, 'Super Lega', 'var(--sl-color)');
            const coppaUefaBracket = createBracket(coppaUefaTeams, 6, 'Coppa UEFA', 'var(--cu-color)');

            tabelloniContainer.innerHTML = superLegaBracket + coppaUefaBracket;
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('tabelloni-finali').innerHTML = `<pre style="color: red;">${error.stack}</pre>`;
            }
        });
    </script>
</body>
</html>